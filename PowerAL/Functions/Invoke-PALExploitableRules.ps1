function Invoke-PALExploitableRules
{
<#
.SYNOPSIS

Gets AppLocker rules that can be exploited.

Author: @oddvarmoe
License: BSD 3-Clause
Required Dependencies: Get-PALRules, Get-PALRuleStatus
Optional Dependencies: None

.DESCRIPTION

Checking AppLocker rules and looks for known weaknesses in configuration that can be exploited.

.EXAMPLE

PS C:\> Get-PALExploitableRules

Get-PALExploitableRules

[*] Checking for Exploitable AppLocker rules

[*] Checking Publisher rules
[+] Trust all signed rule found in Appx
[+] Get yourself a code signing cert and start a party!


Ruletype      : FilePublisherRule
Action        : Allow
SID           : S-1-1-0
Description   : Allows members of the Everyone group to run packaged apps that are signed.
Name          : (Default Rule) All signed packaged apps
Id            : a9e18c21-ff8f-43cf-b9fc-db40eed693ba
PublisherName : *
Productname   : *
BinaryName    : *
LowSection    : 0.0.0.0
HighSection   : *

[+] Trust all signed rule found in Msi
[+] Get yourself a code signing cert and start a party!
Ruletype      : FilePublisherRule
Action        : Allow
SID           : S-1-1-0
Description   : Allows members of the Everyone group to run digitally signed Windows Installer files.
Name          : (Default Rule) All digitally signed Windows Installer files
Id            : b7af7102-efde-4369-8a89-7a6a392d1473
PublisherName : *
Productname   : *
BinaryName    : *
LowSection    : 0.0.0.0
HighSection   : *


[*] Checking for missing or incorrect path rules
[+] Did not find any deny rules
[+] Did not find any rules blocking executing from Alternate Data Streams
[+] Exploit by adding a binary to a stream of a folder inside an allowed path. EX: type file.exe > c:\windows\tasks:file.exe

[*] Checking for denied AppLocker hash rules
[+] Did not find any hash deny rules
#>    
    [CmdletBinding()] Param (
        [String]$OfflineXML
    )
    Process
    {
        Try
        {
            If($OfflineXML)
            {
                "`n[*] Checking for Exploitable AppLocker rules from Offline XML"
                $PublisherRules = Get-PALRules -OutputRules Publisher -RuleActions Allow -OfflineXML $OfflineXML
                $DenyPathRules = Get-PALRules -OutputRules Path -RuleActions Deny -OfflineXML $OfflineXML
                $DenyHashRules = Get-PALRules -OutputRules Hash -RuleActions Deny -OfflineXML $OfflineXML
            }
            else
            {
                "`n[*] Checking for Exploitable AppLocker rules"
                $PublisherRules = Get-PALRules -OutputRules Publisher -RuleActions Allow
                $DenyPathRules = Get-PALRules -OutputRules Path -RuleActions Deny
                $DenyHashRules = Get-PALRules -OutputRules Hash -RuleActions Deny
            }
            
            #Check if there exists a trust all signed binaries rule
            "`n[*] Checking Publisher rules"
            if($PublisherRules)
            {
                ForEach($Pubr in $PublisherRules)
                {
                    if($pubr.RulesList.Publishername -eq "*")
                    {
                        "[+] Trust all signed rule found in $($pubr.name)"
                        "[+] Get yourself a code signing cert and start a party!"
                        $pubr.RulesList
                    }
                }
            }

            #Check if there is an incorrect path rule
            "`n[*] Checking for missing or incorrect path rules"
            if($DenyPathRules)
            {
                ForEach($DPR in $DenyPathRules.RulesList.RulePath)
                {
                    if(!($DPR -match "\\\*$" -or $DPR -match "\.\w{2,4}$"))
                    {
                        "[+] Found misconfigured deny path rule - Missing asterix (*) - Rule has no effect"
                        $DPR    
                    }

                    if(!($DPR -match "\:\*$"))
                    {
                       "[+] Did not find any rules blocking executing from Alternate Data Streams"
                    }
                }
            }
            else{
                "[+] Did not find any deny rules"
                "[+] Did not find any rules blocking execution from Alternate Data Streams"
                "[+] Exploit by adding a binary to a stream of a folder inside an allowed path. EX: type file.exe > c:\windows\tasks:file.exe"
            }

            #Check if there are rules that denies a file hash
            "`n[*] Checking for denied AppLocker hash rules"
            if($DenyHashRules)
            {
                ForEach($HR in $DenyHashRules)
                {
                    "[+] Found hash deny rule" 
                    "[+] - Add content to file and execute: copy /b blockedfile.exe+txtfile.txt newfile.txt"
                    $HR.RulesList | fl *
                }
            }
            else
            {
                "[+] Did not find any hash deny rules"
            }

            #Check if some of the rule collections is not configured
            "`n[*] Checking rule collection status to see if one collection is not enabled"
            $rulesstatus = Get-PALRulesStatus
            foreach($ruless in $rulesstatus)
            {
                if($ruless.status -ne "Enforced")
                {
                    "[+] $($ruless.Name) is not enforced. Have fun!"
                }
            }
        }
        Catch
        {
            write-error $_
        }
        Finally{}
    }
}